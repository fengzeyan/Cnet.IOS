// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using System.Linq;
using MonoTouch.UIKit;
using Cnt.API;
using Cnt.Web.API.Models;
using MonoTouch.Foundation;

namespace Cnet.iOS
{
	public partial class OSAssignmentViewController : UIViewController
	{
		OSAssignmentTableSource completedPlacements;
		OSAssignmentTableSource upcomingPlacements;

		public OSAssignmentViewController (IntPtr handle) : base (handle)
		{
		}

		public override void ViewDidLoad ()
		{
			base.ViewDidLoad ();
			Client client = AuthenticationHelper.GetClient ();
			completedPlacements = new OSAssignmentTableSource (OSAssignmentsTableViewCellType.Completed, new List<Placement> (client.PlacementService.GetPlacements ().Take (10)));
			upcomingPlacements = new OSAssignmentTableSource (OSAssignmentsTableViewCellType.Upcoming, new List<Placement> (client.PlacementService.GetPlacements ()));
			this.assignmentsTable.Source = upcomingPlacements;
		}

		partial void completedSwitchPressed (UIButton sender)
		{
			this.completedButton.Selected = true;
			this.upcomingButton.Selected = false;
			this.assignmentsTable.Source = completedPlacements;
			this.assignmentsTable.ReloadData();
		}

		partial void upcomingSwitchPressed (UIButton sender)
		{
			this.upcomingButton.Selected = true;
			this.completedButton.Selected = false;
			this.assignmentsTable.Source = upcomingPlacements;
			this.assignmentsTable.ReloadData();
		}
	}

	public class OSAssignmentTableSource : UITableViewSource
	{
		private OSAssignmentsTableViewCellType tableType;
		private List<Placement> tableItems;
		static NSString OSAssignmentsTableViewCellId = new NSString ("AssignmentsCellIdentifier");


		public OSAssignmentTableSource(OSAssignmentsTableViewCellType type, List<Placement> items) : base()
		{
			tableType = type;
			tableItems = items;
		}

		public override int RowsInSection (UITableView tableview, int section)
		{
			return tableItems.Count;
		}

		public override UITableViewCell GetCell (UITableView tableView, NSIndexPath indexPath)
		{
			OSAssignmentsTableViewCell cell = (OSAssignmentsTableViewCell)tableView.DequeueReusableCell (OSAssignmentsTableViewCellId, indexPath);
			cell.BelowProfilePicLabel.Text = tableType.ToString();
			cell.BookmarkImage.Image = new UIImage ();
			cell.ChildrenLabel.Text = tableItems [indexPath.Row].Students.Count() + " children";
			cell.DateLabel.Text = tableItems [indexPath.Row].Start.ToString("ddd d MMM");
			cell.FamilyNameLabel.Text = tableItems [indexPath.Row].ClientName;
			if (tableType == OSAssignmentsTableViewCellType.Completed)
				cell.InfoImage.Image = new UIImage ("icon-check.png");
			else
				cell.InfoImage.Image = new UIImage ();

			Address location = tableItems[indexPath.Row].Location;
			cell.LocationLabel.Text = location != null ? location.City + ", " + location.State : String.Empty;

			cell.ProfileImage.Image = Utility.UIImageFromUrl(tableItems [indexPath.Row].ClientPhoto);

			//cell.PurpleInfoImage.Image = new UIImage ();
			//cell.PurpleInfoLabel.Text = tableItems [indexPath.Row].ClientName + " ago";

			Schedule nextSchedule = tableItems [indexPath.Row].Schedules.FirstOrDefault ();
			cell.TimeLabel.Text = nextSchedule != null ? nextSchedule.Time.ToFormattedString() : String.Empty;
			return cell;
		}
	}

	public enum OSAssignmentsTableViewCellType
	{
		Completed,
		Upcoming
	}
}